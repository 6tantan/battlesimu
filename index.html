<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Project Hope Prototype（gameflow 確認）</title>
  <meta name="description" content="Project Hope single-file prototype: React 18 UMD (production), Tailwind CDN, no Babel.">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .scroll-soft { scrollbar-width: thin; scrollbar-color: #999 transparent; }
    .scroll-soft::-webkit-scrollbar { width: 8px; height: 8px; }
    .scroll-soft::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
    .scroll-soft::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div id="root"></div>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script>
  (function () {
    const { useState, useEffect, useMemo } = React;
    const h = React.createElement;
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const uid = (() => { let i = 1; return () => (i++).toString(); })();
    function deepMerge(target, src) { if (typeof src !== 'object' || src === null) return src; if (Array.isArray(src)) return src.map(x => deepMerge({}, x)); const out = Object.assign({}, target); for (const k in src) { out[k] = deepMerge(out[k], src[k]); } return out; }
    function rng() { let x = Math.floor(Math.random() * 2**31); return () => { x ^= x << 13; x ^= x >> 17; x ^= x << 5; return (x >>> 0) / 2**32; }; }

    // ────────────────── 成長曲線資料（由 Excel 轉出） ──────────────────
    // p50: Lv50 時，已達 Lv99 成長的百分比（0~1），用來求曲線指數 k。
    const CLASS_GROWTH = {
  "KAHu": {
    "name": "人類鬥士KAHu",
    "lv1": {
      "HP": 40.0,
      "MP": 25.0,
      "POW": 45.0,
      "DEF": 17.0,
      "INT": 29.0,
      "DEX": 68.0,
      "EVA": 45.0
    },
    "lv99": {
      "HP": 140.0,
      "MP": 60.0,
      "POW": 92.0,
      "DEF": 42.0,
      "INT": 58.0,
      "DEX": 18.0,
      "EVA": 68.0
    },
    "p50": 0.6
  },
  "STHu": {
    "name": "人類射手 STHu",
    "lv1": {
      "HP": 29.0,
      "MP": 20.0,
      "POW": 23.0,
      "DEF": 13.0,
      "INT": 20.0,
      "DEX": 80.0,
      "EVA": 36.0
    },
    "lv99": {
      "HP": 120.0,
      "MP": 70.0,
      "POW": 80.0,
      "DEF": 36.0,
      "INT": 50.0,
      "DEX": 23.0,
      "EVA": 64.0
    },
    "p50": 0.6
  },
  "MAHu": {
    "name": "人類法師 MAHu",
    "lv1": {
      "HP": 33.0,
      "MP": 48.0,
      "POW": 30.4,
      "DEF": 12.8,
      "INT": 39.6,
      "DEX": 7.0,
      "EVA": 28.0
    },
    "lv99": {
      "HP": 110.0,
      "MP": 160.0,
      "POW": 76.0,
      "DEF": 32.0,
      "INT": 99.0,
      "DEX": 14.0,
      "EVA": 56.0
    },
    "p50": 0.6
  },
  "KABe": {
    "name": "獸族鬥士 KABe",
    "lv1": {
      "HP": 48.0,
      "MP": 15.0,
      "POW": 43.2,
      "DEF": 18.4,
      "INT": 15.2,
      "DEX": 8.0,
      "EVA": 29.0
    },
    "lv99": {
      "HP": 160.0,
      "MP": 50.0,
      "POW": 108.0,
      "DEF": 46.0,
      "INT": 38.0,
      "DEX": 16.0,
      "EVA": 58.0
    },
    "p50": 0.6
  },
  "STBe": {
    "name": "獸族射手 STBe",
    "lv1": {
      "HP": 42.0,
      "MP": 18.0,
      "POW": 36.0,
      "DEF": 16.0,
      "INT": 13.6,
      "DEX": 11.0,
      "EVA": 27.0
    },
    "lv99": {
      "HP": 140.0,
      "MP": 60.0,
      "POW": 90.0,
      "DEF": 40.0,
      "INT": 34.0,
      "DEX": 22.0,
      "EVA": 54.0
    },
    "p50": 0.6
  },
  "MABe": {
    "name": "獸族法師 MABe",
    "lv1": {
      "HP": 39.0,
      "MP": 42.0,
      "POW": 31.2,
      "DEF": 15.2,
      "INT": 36.0,
      "DEX": 5.5,
      "EVA": 23.0
    },
    "lv99": {
      "HP": 130.0,
      "MP": 140.0,
      "POW": 78.0,
      "DEF": 38.0,
      "INT": 90.0,
      "DEX": 11.0,
      "EVA": 46.0
    },
    "p50": 0.6
  },
  "KAFa": {
    "name": "奇幻鬥士 KAFa",
    "lv1": {
      "HP": 42.0,
      "MP": 18.0,
      "POW": 35.2,
      "DEF": 16.0,
      "INT": 27.2,
      "DEX": 10.0,
      "EVA": 34.0
    },
    "lv99": {
      "HP": 140.0,
      "MP": 60.0,
      "POW": 88.0,
      "DEF": 40.0,
      "INT": 68.0,
      "DEX": 20.0,
      "EVA": 68.0
    },
    "p50": 0.6
  },
  "STFa": {
    "name": "奇幻射手 STFa",
    "lv1": {
      "HP": 36.0,
      "MP": 21.0,
      "POW": 28.0,
      "DEF": 12.8,
      "INT": 24.0,
      "DEX": 12.0,
      "EVA": 32.0
    },
    "lv99": {
      "HP": 120.0,
      "MP": 70.0,
      "POW": 70.0,
      "DEF": 32.0,
      "INT": 60.0,
      "DEX": 24.0,
      "EVA": 64.0
    },
    "p50": 0.6
  },
  "MAFa": {
    "name": "奇幻法師 MAFa",
    "lv1": {
      "HP": 33.0,
      "MP": 48.0,
      "POW": 26.4,
      "DEF": 12.0,
      "INT": 43.6,
      "DEX": 8.0,
      "EVA": 28.0
    },
    "lv99": {
      "HP": 110.0,
      "MP": 160.0,
      "POW": 66.0,
      "DEF": 30.0,
      "INT": 109.0,
      "DEX": 16.0,
      "EVA": 56.0
    },
    "p50": 0.6
  },
  "KAMe": {
    "name": "機甲鬥士 KAMe",
    "lv1": {
      "HP": 54.0,
      "MP": 0.0,
      "POW": 50.0,
      "DEF": 24.0,
      "INT": 0.0,
      "DEX": 10.0,
      "EVA": 34.0
    },
    "lv99": {
      "HP": 180.0,
      "MP": 0.0,
      "POW": 125.0,
      "DEF": 60.0,
      "INT": 0.0,
      "DEX": 20.0,
      "EVA": 68.0
    },
    "p50": 0.6
  },
  "STKa": {
    "name": "機甲射手 STKa",
    "lv1": {
      "HP": 45.0,
      "MP": 0.0,
      "POW": 31.2,
      "DEF": 19.2,
      "INT": 0.0,
      "DEX": 15.0,
      "EVA": 32.0
    },
    "lv99": {
      "HP": 150.0,
      "MP": 0.0,
      "POW": 78.0,
      "DEF": 48.0,
      "INT": 0.0,
      "DEX": 30.0,
      "EVA": 64.0
    },
    "p50": 0.6
  },
  "STDe": {
    "name": "神祈射手 STDe",
    "lv1": {
      "HP": 33.0,
      "MP": 28.5,
      "POW": 26.4,
      "DEF": 12.0,
      "INT": 31.2,
      "DEX": 10.0,
      "EVA": 35.0
    },
    "lv99": {
      "HP": 110.0,
      "MP": 95.0,
      "POW": 66.0,
      "DEF": 30.0,
      "INT": 78.0,
      "DEX": 20.0,
      "EVA": 70.0
    },
    "p50": 0.6
  },
  "MADe": {
    "name": "神祈法師 MADe",
    "lv1": {
      "HP": 27.0,
      "MP": 60.0,
      "POW": 18.0,
      "DEF": 11.2,
      "INT": 46.0,
      "DEX": 5.0,
      "EVA": 30.0
    },
    "lv99": {
      "HP": 90.0,
      "MP": 200.0,
      "POW": 45.0,
      "DEF": 28.0,
      "INT": 115.0,
      "DEX": 10.0,
      "EVA": 60.0
    },
    "p50": 0.6
  },
  "KAMo": {
    "name": "惡魔鬥士 KAMo",
    "lv1": {
      "HP": 30.0,
      "MP": 12.0,
      "POW": 48.0,
      "DEF": 20.0,
      "INT": 8.0,
      "DEX": 8.0,
      "EVA": 29.0
    },
    "lv99": {
      "HP": 100.0,
      "MP": 40.0,
      "POW": 120.0,
      "DEF": 50.0,
      "INT": 20.0,
      "DEX": 16.0,
      "EVA": 58.0
    },
    "p50": 0.6
  },
  "MAMo": {
    "name": "惡魔法師 MAMo",
    "lv1": {
      "HP": 27.0,
      "MP": 30.0,
      "POW": 30.0,
      "DEF": 11.2,
      "INT": 32.0,
      "DEX": 5.0,
      "EVA": 30.0
    },
    "lv99": {
      "HP": 90.0,
      "MP": 100.0,
      "POW": 75.0,
      "DEF": 28.0,
      "INT": 80.0,
      "DEX": 10.0,
      "EVA": 60.0
    },
    "p50": 0.6
  }
};

    // 允許別名（Excel 中「機甲射手 STKa」對應舊代碼 STMe）
    const CODE_ALIAS = { STKa: "STMe" };

    function growthOf(code) {
      const g = CLASS_GROWTH[code] || CLASS_GROWTH[CODE_ALIAS[code]] || null;
      return g;
    }

    function makeScaler(g) {
      const t50 = 49/98; // Lv 50
      const p50 = g.p50 ?? 0.6;
      const k = Math.max(0.01, Math.min(10, Math.log(p50) / Math.log(t50))); // f(t)=t^k
      return function scaleAt(lv) {
        const t = clamp((lv-1)/98, 0, 1);
        const f = Math.pow(t, k);
        const out = {};
        const lv1 = g.lv1, lv99 = g.lv99;
        for (const key of ["HP","MP","POW","DEF","INT","DEX","EVA"]) {
          const a = lv1[key] ?? 1, b = lv99[key] ?? a;
          out[key] = Math.round(a + (b - a) * f);
        }
        return out;
      };
    }

    // ────────────────── 常數資料 ──────────────────
    const STARS = [
      { abbr: "FL", symbol: "♌", name: "焰鬃" }, { abbr: "WA", symbol: "♈", name: "戰角" },
      { abbr: "SN", symbol: "♍", name: "砂巢" }, { abbr: "TS", symbol: "♐", name: "天矢" },
      { abbr: "TW", symbol: "♊", name: "雙星" }, { abbr: "CR", symbol: "♋", name: "月潮" },
      { abbr: "SC", symbol: "♏", name: "蠍檢" }, { abbr: "AQ", symbol: "♒", name: "流泉" },
      { abbr: "CP", symbol: "♑", name: "岩蹄" }, { abbr: "LB", symbol: "♎", name: "衡鏡" },
      { abbr: "AR", symbol: "♈", name: "白角" }, { abbr: "PI", symbol: "♓", name: "幽鰭" },
    ];

    const RACES = [
      { key: "Arrogant", label: "傲慢 Arrogant" },
      { key: "Bile", label: "憤怒 Bile" },
      { key: "Credulity", label: "盲信 Credulity" },
      { key: "Defamation", label: "誣衊 Defamation" },
    ];

    const JOBS = {
      KAHu: "人鬥士", STHu: "人射手", MAHu: "人法師",
      KABe: "獸鬥士", STBe: "獸射手", MABe: "獸法師",
      KAFa: "幻鬥士", STFa: "幻射手", MAFa: "幻法師",
      KAMe: "機鬥士", STMe: "機射手", STKa: "機甲射手",
      STDe: "神射手", MADe: "神法師",
      KAMo: "魔鬥士", MAMo: "魔法師"
    };

    function starPick(i) { return STARS[i % STARS.length]; }
    function mkStats(hp, mp, pow, def, intv, dex, eva) { return { HP: hp, MP: mp, POW: pow, DEF: def, INT: intv, DEX: dex, EVA: eva }; }

    const EQUIPMENT = {
      weapon: [
        { id: "w_saber", name: "初鋒軍刀", slot: "weapon", bonus: { POW: 6, DEX: 2 }, vsRace: {} },
        { id: "w_longbow", name: "白木長弓", slot: "weapon", bonus: { POW: 4, DEX: 5 }, vsRace: {} },
        { id: "w_focuswand", name: "專注法杖", slot: "weapon", bonus: { INT: 8, MP: 10 }, vsRace: {} },
        { id: "w_smasher", name: "碎巖槌", slot: "weapon", bonus: { POW: 10, DEX: -2 }, vsRace: {} },
      ],
      body: [
        { id: "b_leather", name: "旅者皮甲", slot: "body", bonus: { DEF: 6, EVA: 2 } },
        { id: "b_mail", name: "鎖甲背心", slot: "body", bonus: { DEF: 10, DEX: -1 } },
        { id: "b_robe", name: "祈願法袍", slot: "body", bonus: { MP: 12, INT: 3 } },
      ],
      accessory: [
        { id: "a_band", name: "敏捷織環", slot: "accessory", bonus: { DEX: 4, EVA: 3 } },
        { id: "a_charm", name: "火紋護符", slot: "accessory", bonus: { POW: 3, INT: 3 } },
        { id: "a_medal", name: "開拓者勳章", slot: "accessory", bonus: { HP: 15 } },
      ]
    };

    function scaleByJob(jobCode, lv) {
      const g = growthOf(jobCode);
      if (!g) return null;
      const scaler = makeScaler(g);
      return scaler(lv);
    }

    function mkCharFromJob({ name, jobCode, lv, starIndex }) {
      const star = starPick(starIndex||0);
      const base = scaleByJob(jobCode, lv) || mkStats(80,30,12,8,6,12,9);
      return {
        id: uid(), name, jobCode, lv, star, starText: star.abbr + " " + star.symbol,
        baseStats: base, eq: { weapon: null, body: null, accessory: null },
        cur: { HP: base.HP, MP: base.MP }, isPlayer: false
      };
    }

    const COMP_POOL = [
      mkCharFromJob({ name: "Lin", jobCode: "STHu", lv: 8, starIndex: 1 }),
      mkCharFromJob({ name: "Rau", jobCode: "KABe", lv: 9, starIndex: 2 }),
      mkCharFromJob({ name: "Miri", jobCode: "MAHu", lv: 8, starIndex: 3 }),
      mkCharFromJob({ name: "Tor", jobCode: "KAMe", lv: 7, starIndex: 4 }),
      mkCharFromJob({ name: "Sae", jobCode: "STFa", lv: 9, starIndex: 5 }),
      mkCharFromJob({ name: "Dia", jobCode: "MADe", lv: 10, starIndex: 6 }),
      mkCharFromJob({ name: "Mog", jobCode: "KAMo", lv: 9, starIndex: 7 }),
      mkCharFromJob({ name: "Vik", jobCode: "STKa", lv: 8, starIndex: 8 }),
    ];

    const PLAYER = (() => {
      const base = scaleByJob("KAHu", 10) || mkStats(90, 30, 14, 10, 6, 12, 9);
      return { id: uid(), name: "Player", jobCode: "KAHu", lv: 10, star: STARS[0], starText: "FL ♌",
        baseStats: base, eq: { weapon: EQUIPMENT.weapon[0], body: EQUIPMENT.body[0], accessory: EQUIPMENT.accessory[2] },
        cur: { HP: base.HP, MP: base.MP }, isPlayer: true };
    })();

    function addStats(a, b) { return { HP: (a.HP||0)+(b.HP||0), MP: (a.MP||0)+(b.MP||0), POW: (a.POW||0)+(b.POW||0), DEF: (a.DEF||0)+(b.DEF||0), INT: (a.INT||0)+(b.INT||0), DEX: (a.DEX||0)+(b.DEX||0), EVA: (a.EVA||0)+(b.EVA||0) }; }

    function baseOf(ch) {
      const byJob = scaleByJob(ch.jobCode, ch.lv);
      return byJob || ch.baseStats || mkStats(60,20,10,8,6,10,8);
    }

    function effStats(ch) {
      let bonus = { HP: 0, MP: 0, POW: 0, DEF: 0, INT: 0, DEX: 0, EVA: 0 };
      ["weapon","body","accessory"].forEach(slot => { const it = ch.eq[slot]; if (it && it.bonus) bonus = addStats(bonus, it.bonus); });
      const out = addStats(baseOf(ch), bonus);
      return out;
    }

    const STEP_BONUS = [0, 10, 20];
    const MOVE_DATA = { L: { name: "輕擊", mult: 0.9, acc: +10, mp: 0, type: "phys" }, H: { name: "重擊", mult: 1.25, acc: -5, mp: 0, type: "phys" }, S: { name: "特擊", mult: 1.1, acc: 0, mp: 5, type: "hybr" } };
    function formatJob(jobCode) { return (JOBS[jobCode] || jobCode); }

    function mkEnemySet(diff) {
      const base = {
        Normal: [ { name: "荒原徘徊者", base: mkStats(60, 0, 10, 6, 2, 10, 7), race: "Bile" },
                  { name: "沙漠鬣蜥", base: mkStats(70, 0, 12, 7, 2, 11, 8), race: "Arrogant" },
                  { name: "廢土土匪", base: mkStats(80, 0, 13, 8, 3, 12, 9), race: "Defamation" } ],
        Hard:   [ { name: "蒙面狂信徒", base: mkStats(95, 0, 15, 9, 4, 13, 9), race: "Credulity" },
                  { name: "地下潛獵蛛", base: mkStats(100, 0, 16, 10, 3, 14, 11), race: "Bile" },
                  { name: "機動警衛", base: mkStats(110, 0, 17, 12, 3, 13, 10), race: "Arrogant" },
                  { name: "實驗失控體", base: mkStats(120, 0, 18, 12, 5, 12, 9), race: "Defamation" },
                  { name: "狂信處刑官(精英)", base: mkStats(150, 10, 20, 14, 6, 14, 10), race: "Credulity" } ],
        VeryHard: [ { name: "異端先鋒", base: mkStats(120, 10, 18, 12, 6, 15, 11), race: "Credulity" },
                    { name: "重裝破城獸", base: mkStats(160, 0, 21, 16, 4, 12, 8), race: "Bile" },
                    { name: "黑曜影弓", base: mkStats(130, 10, 17, 12, 8, 18, 12), race: "Defamation" },
                    { name: "地熱石衛", base: mkStats(180, 0, 22, 18, 4, 11, 7), race: "Arrogant" },
                    { name: "深層回聲", base: mkStats(140, 30, 16, 13, 10, 14, 11), race: "Defamation" },
                    { name: "虛空讒言者", base: mkStats(150, 30, 19, 16, 10, 15, 12), race: "Credulity" },
                    { name: "Evil Tuma(最終Boss)", base: mkStats(240, 50, 26, 20, 12, 17, 12), race: "Arrogant" } ],
      };
      return base[diff];
    }

    function healBetweenRooms(party) { return party.map(ch => { const eff = effStats(ch); const hpDelta = Math.floor(eff.HP * 0.08); const mpDelta = Math.floor(eff.MP * 0.08); const curHP = clamp(ch.cur.HP + hpDelta, 0, eff.HP); const curMP = clamp(ch.cur.MP + mpDelta, 0, eff.MP); return { ...ch, cur: { HP: curHP, MP: curMP } }; }); }
    function fullHeal(team) { return team.map(ch => { const eff = effStats(ch); return { ...ch, cur: { HP: eff.HP, MP: eff.MP } }; }); }
    function alive(list) { return list.filter(x => x.cur.HP > 0); }

    function stepAttack(attacker, target, stepIndex, patternSymbol, rngf) {
      const move = MOVE_DATA[patternSymbol || "L"];
      const a = effStats(attacker); const d = effStats(target);
      let acc = 70 + (a.DEX - d.EVA) * 0.5 + STEP_BONUS[stepIndex] + move.acc;
      acc = clamp(Math.round(acc), 5, 95);
      const roll = Math.floor(rngf() * 100) + 1;
      const hit = roll <= acc;
      if (!hit) return { hit: false, damage: 0, acc, roll, text: attacker.name + " 的" + move.name + "落空（命中" + acc + "% vs 擲出" + roll + "）" };
      let atk = move.type === "hybr" ? (a.POW + Math.floor(a.INT * 0.5)) : a.POW;
      let dmg = Math.floor(move.mult * Math.max(1, atk - Math.floor(d.DEF * 0.5)));

      // 種族相剋（武器對目標種族的加成）
      const weapon = attacker.eq?.weapon;
      const raceKey = target.race || target.metaRace;
      const raceMult = (weapon && weapon.vsRace && raceKey && weapon.vsRace[raceKey]) ? weapon.vsRace[raceKey] : 1.0;
      if (raceMult !== 1.0) dmg = Math.floor(dmg * raceMult);

      const critChance = clamp(5 + Math.floor((a.DEX - d.EVA) * 0.2), 3, 30);
      const critRoll = Math.floor(rngf() * 100) + 1;
      const crit = critRoll <= critChance;
      if (crit) dmg = Math.floor(dmg * 1.6);
      let mpSpent = 0; if (move.mp > 0) mpSpent = Math.min(move.mp, attacker.cur.MP);
      return { hit: true, damage: Math.max(1, dmg), acc, roll, crit, critChance, mpSpent, text: attacker.name + " 使用" + move.name + (crit ? "爆擊" : "") + " 造成 " + Math.max(1, dmg) + " 傷害（命中" + acc + "%）" };
    }

    function simulateRound(party, enemies, playerPattern, enemyPattern, logArr, roomIndex) {
      const rnd = rng();
      const actors = [...party.map(c => ({ side: "ally", c })), ...enemies.map(c => ({ side: "foe", c }))].sort((a, b) => effStats(b.c).DEX - effStats(a.c).DEX);
      const newLogs = []; let partyNew = party.map(x => ({...x, cur: {...x.cur}})); let enemyNew = enemies.map(x => ({...x, cur: {...x.cur}}));
      function refOf(id, side) { return side === "ally" ? partyNew.find(x => x.id === id) : enemyNew.find(x => x.id === id); }
      for (const actor of actors) {
        const me = refOf(actor.c.id, actor.side); if (!me || me.cur.HP <= 0) continue;
        const opponents = actor.side === "ally" ? enemyNew : partyNew; const target = opponents.find(x => x.cur.HP > 0); if (!target) continue;
        for (let si = 0; si < 3; si++) {
          const patt = actor.side === "ally" ? (playerPattern || ["L","H","S"])[si] : (enemyPattern || ["L","L","L"])[si];
          const r = stepAttack(me, target, si, patt, rnd); if (r.mpSpent) me.cur.MP = Math.max(0, me.cur.MP - r.mpSpent);
          newLogs.push("[房間" + (roomIndex+1) + "] " + r.text);
          if (r.hit) { target.cur.HP = Math.max(0, target.cur.HP - r.damage); if (target.cur.HP <= 0) { newLogs.push("[房間" + (roomIndex+1) + "] " + target.name + " 倒下了！"); break; } }
        }
      }
      const partyAlive = alive(partyNew).length > 0; const enemyAlive = alive(enemyNew).length > 0;
      let outcome = "ongoing"; if (!enemyAlive && partyAlive) outcome = "victory"; else if (!partyAlive) outcome = "defeat";
      const mergedLogs = logArr.concat(newLogs); return { party: partyNew, enemies: enemyNew, logs: mergedLogs, outcome };
    }

    function SectionCard({ title, children, className }) { return h("div", { className: "bg-slate-900/70 border border-slate-700 rounded-2xl p-4 shadow-xl " + (className||"") }, h("div", { className: "text-lg font-bold mb-2 text-slate-200" }, title), children); }
    function StatRow({ label, val, className }) { return h("div", { className: "flex justify-between text-sm " + (className||"") }, h("span", { className: "text-slate-400" }, label), h("span", { className: "font-mono" }, val)); }
    function Pill({ children, className }) { return h("span", { className: "inline-flex items-center px-2 py-0.5 rounded-full bg-slate-800 border border-slate-600 text-slate-200 text-xs " + (className||"") }, children); }
    function HpMpBar({ cur, max, color }) { const pct = Math.round((cur / Math.max(1,max)) * 100); return h("div", { className: "w-full bg-slate-800 rounded h-2 overflow-hidden border border-slate-700" }, h("div", { className: "h-2 " + (color || "bg-green-500"), style: { width: pct + "%" } })); }
    function CharCard({ ch, showEquip, compact }) {
      const eff = effStats(ch);
      const raceLabel = ch.race ? (RACES.find(r => r.key===ch.race)?.label || ch.race) : null;
      return h("div", { className: "bg-slate-900/60 rounded-xl p-3 border border-slate-700" },
        h("div", { className: "flex items-center justify-between gap-2" },
          h("div", null,
            h("div", { className: "font-semibold" }, ch.name, " ", h("span", { className: "text-xs text-slate-400" }, "(" + (ch.isPlayer ? "玩家 " : "") + formatJob(ch.jobCode) + " Lv" + ch.lv + ")")),
            h("div", { className: "text-xs text-slate-400" }, ch.star?.abbr || "--", " ", ch.star?.symbol || "", raceLabel ? " · " + raceLabel : "")
          ),
          showEquip ? h("div", { className: "text-xs grid grid-cols-3 gap-1" }, ["weapon","body","accessory"].map(slot => h(Pill, { key: slot }, (ch.eq?.[slot]?.name || (slot==="weapon"?"武器": slot==="body"?"身體":"副裝"))))) : null
        ),
        !compact && h("div", { className: "mt-2 space-y-1" },
          h("div", { className: "text-xs" }, "HP " + (ch.cur?.HP||0) + "/" + eff.HP),
          h(HpMpBar, { cur: ch.cur?.HP || 0, max: eff.HP, color: "bg-emerald-500" }),
          h("div", { className: "text-xs" }, "MP " + (ch.cur?.MP||0) + "/" + eff.MP),
          h(HpMpBar, { cur: ch.cur?.MP || 0, max: eff.MP, color: "bg-sky-500" }),
          h("div", { className: "grid grid-cols-3 gap-2 text-xs mt-2" },
            h(StatRow, { label: "POW", val: eff.POW }),
            h(StatRow, { label: "DEF", val: eff.DEF }),
            h(StatRow, { label: "INT", val: eff.INT }),
            h(StatRow, { label: "DEX", val: eff.DEX }),
            h(StatRow, { label: "EVA", val: eff.EVA }))
        )
      );
    }

    function Header({ onOpenEquip, onOpenBag, onOpenSettings, onHome, onOpenSim }) { return h("div", { className: "flex items-center justify-between px-4 py-3 bg-slate-900/80 border-b border-slate-800 sticky top-0 z-10 backdrop-blur" },
      h("div", { className: "flex items-center gap-3" }, h("button", { onClick: onHome, className: "text-xl font-black tracking-wide hover:text-emerald-300 transition" }, "Project Hope"), h("span", { className: "text-xs text-slate-400" }, "Prototype · gameflow 確認")),
      h("div", { className: "flex items-center gap-2" },
        h("button", { className: "px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-sm", onClick: onOpenEquip }, "角色"),
        h("button", { className: "px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-sm", onClick: onOpenBag }, "背包"),
        h("button", { className: "px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-sm", onClick: onOpenSettings }, "設定"),
        h("button", { className: "px-3 py-1.5 rounded-lg bg-emerald-700 hover:bg-emerald-600 text-sm", onClick: onOpenSim }, "資源模擬場"))); }

    function HomeScreen({ goBoard, goRelay, goSim, openLocked, party }) { const BIG = "px-5 py-6 rounded-2xl bg-slate-900/70 border border-slate-700 hover:border-slate-500 transition text-left";
      return h("div", { className: "p-4 max-w-5xl mx-auto" },
        h("div", { className: "grid grid-cols-2 md:grid-cols-4 gap-3" },
          h("button", { className: BIG, onClick: openLocked }, h("div", { className: "text-xl font-bold" }, "星象殿堂"), h("div", { className: "text-xs text-slate-400 mt-1" }, "未開放")),
          h("button", { className: BIG, onClick: goBoard }, h("div", { className: "text-xl font-bold" }, "布告欄"), h("div", { className: "text-xs text-slate-400 mt-1" }, "選擇任務難度")),
          h("button", { className: BIG, onClick: goRelay }, h("div", { className: "text-xl font-bold" }, "連結中繼站"), h("div", { className: "text-xs text-slate-400 mt-1" }, "招募同伴")),
          h("button", { className: BIG, onClick: goSim }, h("div", { className: "text-xl font-bold" }, "資源模擬場"), h("div", { className: "text-xs text-slate-400 mt-1" }, "戰鬥數據測試頁")),
          h("button", { className: BIG, onClick: openLocked }, h("div", { className: "text-xl font-bold" }, "裝備舖"), h("div", { className: "text-xs text-slate-400 mt-1" }, "未開放")),
          h("button", { className: BIG, onClick: openLocked }, h("div", { className: "text-xl font-bold" }, "強化舖"), h("div", { className: "text-xs text-slate-400 mt-1" }, "未開放")),
          h("button", { className: BIG, onClick: openLocked }, h("div", { className: "text-xl font-bold" }, "倉庫"), h("div", { className: "text-xs text-slate-400 mt-1" }, "未開放")) ),
        h("div", { className: "mt-6 grid grid-cols-1 md:grid-cols-2 gap-3" },
          h(SectionCard, { title: "目前隊伍" }, h("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-3" }, party.map(ch => h(CharCard, { ch, key: ch.id, showEquip: true })))),
          h(SectionCard, { title: "提示" }, h("ul", { className: "list-disc list-inside text-sm text-slate-300 space-y-1" },
            h("li", null, "在「布告欄」選擇難度後開始關卡。"),
            h("li", null, "在「準備階段」可調整「玩家」的 L/H/S 三段攻擊流程，並進入「裝備管理」。"),
            h("li", null, "每一房結束後，HP/MP 各回復 8%。回主畫面時全隊回滿。"),
            h("li", null, "戰鬥紀錄會在同一個關卡的房間間保留。"))))); }

    function Board({ onStart, onBack }) { const [diff, setDiff] = useState("Normal");
      return h("div", { className: "p-4 max-w-4xl mx-auto space-y-3" },
        h(SectionCard, { title: "布告欄" },
          h("div", { className: "grid grid-cols-1 sm:grid-cols-3 gap-3" }, ["Normal","Hard","VeryHard"].map(d =>
            h("label", { key: d, className: "flex items-center gap-2 bg-slate-900/60 border border-slate-700 rounded-xl p-3 cursor-pointer" },
              h("input", { type: "radio", name: "diff", checked: diff===d, onChange: () => setDiff(d) }),
              h("div", null, h("div", { className: "font-semibold" }, d),
                h("div", { className: "text-xs text-slate-400" }, d==="Normal"?"3房": d==="Hard"?"5房（最後精英）":"7房（最後 Boss：Evil Tuma）"))))),
          h("div", { className: "flex items-center justify-end gap-2 mt-3" },
            h("button", { onClick: onBack, className: "px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-sm" }, "返回"),
            h("button", { onClick: () => onStart(diff), className: "px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold" }, "開始任務")))); }

    function LinkRelay({ pool, party, onAdd, onRemove, onBack }) { const canAdd = party.length < 4;
      return h("div", { className: "p-4 max-w-5xl mx-auto space-y-3" },
        h(SectionCard, { title: "連結中繼站 · 招募清單" },
          h("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" }, pool.map(c => h("div", { key: c.id, className: "flex items-center justify-between bg-slate-900/60 border border-slate-700 rounded-xl p-3" },
            h("div", null, h("div", { className: "font-semibold" }, c.name + " (" + c.jobCode + "+" + c.lv + ") · " + c.star.abbr + " " + c.star.symbol), h("div", { className: "text-xs text-slate-400" }, formatJob(c.jobCode))),
            h("div", { className: "flex items-center gap-2" }, h("button", { disabled: !canAdd, onClick: () => onAdd(c), className: "px-2 py-1 rounded bg-emerald-600 disabled:bg-slate-700 text-xs" }, "加入"))))),
        h(SectionCard, { title: "當前隊伍（最多 4 人）" },
          h("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-3" }, party.map(ch => h("div", { key: ch.id, className: "flex items-center justify-between bg-slate-900/60 border border-slate-700 rounded-xl p-3" },
            h("div", null, h("div", { className: "font-semibold" }, ch.name + " (" + ch.jobCode + "+" + ch.lv + ") · " + ch.star.abbr + " " + ch.star.symbol), h("div", { className: "text-xs text-slate-400" }, ch.isPlayer ? "玩家" : "同伴")),
            !ch.isPlayer && h("button", { onClick: () => onRemove(ch), className: "px-2 py-1 rounded bg-rose-600 text-xs" }, "移除"))))),
        h("div", { className: "flex items-center justify-end" }, h("button", { onClick: onBack, className: "px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-sm" }, "返回"))); }

    function EquipManager({ party, onEquip, onClose }) { const [index, setIndex] = useState(0); const ch = party[index] || party[0];
      function Slot({ slot, items }) { const cur = ch.eq[slot];
        return h("div", { className: "bg-slate-900/60 border border-slate-700 rounded-xl p-3" },
          h("div", { className: "text-sm font-semibold mb-2" }, slot==="weapon"?"武器": slot==="body"?"身體":"副裝"),
          h("div", { className: "flex flex-wrap gap-2" },
            items.map(it => { const active = cur && cur.id === it.id; return h("button", { key: it.id, className: "px-2 py-1 rounded border text-xs " + (active ? "border-emerald-400 bg-emerald-900/30" : "border-slate-600 bg-slate-800 hover:border-slate-400"), onClick: () => onEquip(ch.id, slot, it) }, it.name); }),
            h("button", { className: "px-2 py-1 rounded border text-xs border-slate-600 bg-slate-800 hover:border-slate-400", onClick: () => onEquip(ch.id, slot, null) }, "卸下")));
      }
      return h("div", { className: "p-4 max-w-5xl mx-auto space-y-3" }, h(SectionCard, { title: "裝備管理" },
        h("div", { className: "flex items-center gap-2 mb-3" }, h("label", { className: "text-sm text-slate-300" }, "角色："),
          h("select", { value: index, onChange: e => setIndex(parseInt(e.target.value, 10)), className: "bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm" }, party.map((p, i) => h("option", { key: p.id, value: i }, p.name + (p.isPlayer?"(玩家)":""))) )),
        ch && h("div", { className: "grid grid-cols-1 md:grid-cols-3 gap-3" }, h("div", { className: "md:col-span-1" }, h(CharCard, { ch })), h("div", { className: "md:col-span-2 grid grid-cols-1 gap-3" }, h(Slot, { slot: "weapon", items: EQUIPMENT.weapon }), h(Slot, { slot: "body", items: EQUIPMENT.body }), h(Slot, { slot: "accessory", items: EQUIPMENT.accessory }), h("div", { className: "text-xs text-slate-400" }, "提示：裝備後的有效屬性已即時反映，戰鬥將以有效屬性計算。"))), h("div", { className: "flex items-center justify-end mt-3" }, h("button", { onClick: onClose, className: "px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-sm" }, "關閉"))); }

    // ────────────────── 資源模擬場（戰鬥數據測試） ──────────────────
    function FieldInput({ label, children }) { return h("label", { className: "text-xs text-slate-300 flex flex-col gap-1" }, h("span", null, label), children); }
    function NumberInput(props) { return h("input", Object.assign({ type: "number", className: "bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm w-full" }, props)); }
    function TextInput(props) { return h("input", Object.assign({ type: "text", className: "bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm w-full" }, props)); }
    function SelectInput({ value, onChange, options }) { return h("select", { value, onChange, className: "bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm w-full" }, options.map(o => h("option", { key: o.value, value: o.value }, o.label))); }
    function PatternPicker({ value, onChange }) { return h("div", { className: "flex items-center gap-2" }, [0,1,2].map(i => h("select", { key: i, value: value[i], onChange: e => { const next = value.slice(); next[i] = e.target.value; onChange(next); }, className: "bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm" }, ["L","H","S"].map(k => h("option", { key: k, value: k }, k))))); }

    function GrowthImport({ onApply }) {
      const [open, setOpen] = useState(false);
      const [text, setText] = useState(JSON.stringify(CLASS_GROWTH, null, 2));
      return h("div", { className: "mt-2" },
        h("button", { onClick: () => setOpen(!open), className: "px-2 py-1 rounded bg-slate-800 border border-slate-700 text-xs" }, open ? "收起成長資料" : "展開/編輯 成長資料（JSON）"),
        open && h("div", { className: "mt-2 space-y-2" },
          h("textarea", { value: text, onChange: e => setText(e.target.value), className: "w-full h-48 bg-slate-900 border border-slate-700 rounded p-2 text-xs font-mono" }),
          h("div", { className: "text-[11px] text-slate-400" }, "格式：{ JobCode: {{ name, lv1:{{HP..}}, lv99:{{HP..}}, p50:0.6 }} }"),
          h("div", null,
            h("button", { onClick: () => { try { const data = JSON.parse(text); onApply(data); alert("成長資料已套用！"); } catch(e) { alert("JSON 解析失敗：" + e.message); } }, className: "px-2 py-1 rounded bg-emerald-600 hover:bg-emerald-500 text-xs font-bold" }, "套用 JSON"))));
    }

    function SimLab({ onBack }) {
      const [ally, setAlly] = useState({
        name: "Tester", lv: 10, jobCode: "KAHu", star: STARS[0], pattern: ["L","H","S"],
        eq: { weapon: null, body: null, accessory: null }
      });
      const allyBase = useMemo(() => scaleByJob(ally.jobCode, ally.lv) || mkStats(90,30,14,10,6,12,9), [ally.jobCode, ally.lv]);
      const baseE = mkEnemySet("Normal")[0].base;
      const [enemy, setEnemy] = useState({
        name: "Target Dummy", lv: 1, pattern: ["L","L","L"], base: { ...baseE }, race: "Arrogant"
      });

      const [log, setLog] = useState([]);
      const [partyState, setPartyState] = useState([{
        id: uid(), name: ally.name, jobCode: ally.jobCode, lv: ally.lv, star: ally.star,
        baseStats: allyBase, eq: ally.eq, cur: { HP: allyBase.HP, MP: allyBase.MP }, isPlayer: true
      }]);
      const [enemyState, setEnemyState] = useState([{
        id: uid(), name: enemy.name, jobCode: "EN", lv: enemy.lv, star: { abbr: "--", symbol: "" },
        baseStats: enemy.base, eq: { weapon: null, body: null, accessory: null }, cur: { HP: enemy.base.HP, MP: enemy.base.MP }, isPlayer: false, race: enemy.race
      }]);

      useEffect(() => {
        const base = scaleByJob(ally.jobCode, ally.lv) || allyBase;
        setPartyState([{
          id: uid(), name: ally.name, jobCode: ally.jobCode, lv: ally.lv, star: ally.star,
          baseStats: base, eq: ally.eq, cur: { HP: base.HP, MP: base.MP }, isPlayer: true
        }]);
      }, [ally.name, ally.lv, ally.jobCode, ally.star, ally.eq]);

      useEffect(() => {
        setEnemyState([{
          id: uid(), name: enemy.name, jobCode: "EN", lv: enemy.lv, star: { abbr: "--", symbol: "" },
          baseStats: enemy.base, eq: { weapon: null, body: null, accessory: null }, cur: { HP: enemy.base.HP, MP: enemy.base.MP }, isPlayer: false, race: enemy.race
        }]);
      }, [enemy.name, enemy.lv, enemy.base, enemy.race]);

      function runOne() { const res = simulateRound(partyState, enemyState, ally.pattern, enemy.pattern, log, 0); setPartyState(res.party); setEnemyState(res.enemies); setLog(res.logs); }
      function resetHPMP() { setPartyState(prev => prev.map(c => ({ ...c, cur: { HP: effStats(c).HP, MP: effStats(c).MP } }))); setEnemyState(prev => prev.map(c => ({ ...c, cur: { HP: effStats(c).HP, MP: effStats(c).MP } }))); }

      return h("div", { className: "p-4 max-w-7xl mx-auto space-y-3" },
        h("div", { className: "flex items-center justify-between" }, h("div", { className: "text-xl font-bold" }, "資源模擬場 · 戰鬥數據測試"), h("div", { className: "flex items-center gap-2" }, h("button", { onClick: onBack, className: "px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-sm" }, "返回主畫面"))),
        h("div", { className: "grid grid-cols-1 lg:grid-cols-3 gap-3" },
          // 左：敵方
          h(SectionCard, { title: "敵方（左側）" },
            h("div", { className: "grid grid-cols-2 gap-2" },
              h(FieldInput, { label: "怪物名稱" }, h(TextInput, { value: enemy.name, onChange: e => setEnemy({ ...enemy, name: e.target.value }) })),
              h(FieldInput, { label: "等級（僅標示）" }, h(NumberInput, { min: 1, max: 200, value: enemy.lv, onChange: e => setEnemy({ ...enemy, lv: parseInt(e.target.value||"1",10) }) })),
              h(FieldInput, { label: "攻擊方式（L/H/S）" }, h(PatternPicker, { value: enemy.pattern, onChange: patt => setEnemy({ ...enemy, pattern: patt }) })),
              h(FieldInput, { label: "種族" }, h(SelectInput, { value: enemy.race, onChange: e => setEnemy({ ...enemy, race: e.target.value }), options: RACES.map(r => ({ value: r.key, label: r.label })) }))
            ),
            h("div", { className: "mt-3 grid grid-cols-2 gap-2" },
              ["HP","MP","POW","DEF","INT","DEX","EVA"].map(k => h(FieldInput, { key:k, label: k }, h(NumberInput, { value: enemy.base[k], onChange: e => setEnemy({ ...enemy, base: { ...enemy.base, [k]: parseInt(e.target.value||"0",10) } }) })))
            ),
            h("div", { className: "mt-3" }, h(CharCard, { ch: enemyState[0], compact: false }))
          ),
          // 中：LOG
          h(SectionCard, { title: "戰鬥 LOG（中間）" },
            h("div", { className: "flex items-center gap-2 mb-2" },
              h("button", { onClick: runOne, className: "px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-bold" }, "進行一回合"),
              h("button", { onClick: resetHPMP, className: "px-3 py-1.5 rounded-lg bg-sky-700 hover:bg-sky-600 text-sm" }, "HP/MP 回滿"),
              h("button", { onClick: () => setLog([]), className: "px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-sm" }, "清空 LOG")
            ),
            h("div", { className: "h-80 overflow-auto scroll-soft text-sm bg-slate-950/50 border border-slate-800 rounded-lg p-2 space-y-1" },
              (log.length ? log : ["（尚無紀錄，按「進行一回合」開始模擬）"]).map((line, i) => h("div", { key: i, className: "text-slate-300" }, line))
            ),
            h("div", { className: "mt-2 text-[11px] text-slate-400" }, "說明：目前怪物等級不影響屬性（無成長表）。武器可支援對「種族」的加成；在裝備資料中填入 vsRace 即可。")
          ),
          // 右：我方
          h(SectionCard, { title: "我方（右側）" },
            h("div", { className: "grid grid-cols-2 gap-2" },
              h(FieldInput, { label: "角色名稱" }, h(TextInput, { value: ally.name, onChange: e => setAlly({ ...ally, name: e.target.value }) })),
              h(FieldInput, { label: "等級" }, h(NumberInput, { min: 1, max: 99, value: ally.lv, onChange: e => setAlly({ ...ally, lv: parseInt(e.target.value||"1",10) }) })),
              h(FieldInput, { label: "職業" }, h(SelectInput, { value: ally.jobCode, onChange: e => setAlly({ ...ally, jobCode: e.target.value }), options: Object.keys(JOBS).map(k => ({ value: k, label: k + " — " + JOBS[k] })) })),
              h(FieldInput, { label: "星紋" }, h(SelectInput, { value: ally.star.abbr, onChange: e => setAlly({ ...ally, star: STARS.find(s => s.abbr === e.target.value) || STARS[0] }), options: STARS.map(s => ({ value: s.abbr, label: s.abbr + " " + s.symbol + " — " + s.name })) })),
              h(FieldInput, { label: "攻擊方式（L/H/S）" }, h(PatternPicker, { value: ally.pattern, onChange: patt => setAlly({ ...ally, pattern: patt }) }))
            ),
            h("div", { className: "mt-3 grid grid-cols-1 md:grid-cols-3 gap-2" },
              h(FieldInput, { label: "武器" }, h(SelectInput, { value: ally.eq.weapon?.id || "", onChange: e => { const v = e.target.value; setAlly({ ...ally, eq: { ...ally.eq, weapon: EQUIPMENT.weapon.find(x => x.id === v) || null } }); }, options: [{ value: "", label: "— 無 —" }].concat(EQUIPMENT.weapon.map(w => ({ value: w.id, label: w.name }))) })),
              h(FieldInput, { label: "身體" }, h(SelectInput, { value: ally.eq.body?.id || "", onChange: e => { const v = e.target.value; setAlly({ ...ally, eq: { ...ally.eq, body: EQUIPMENT.body.find(x => x.id === v) || null } }); }, options: [{ value: "", label: "— 無 —" }].concat(EQUIPMENT.body.map(w => ({ value: w.id, label: w.name }))) })),
              h(FieldInput, { label: "副裝" }, h(SelectInput, { value: ally.eq.accessory?.id || "", onChange: e => { const v = e.target.value; setAlly({ ...ally, eq: { ...ally.eq, accessory: EQUIPMENT.accessory.find(x => x.id === v) || null } }); }, options: [{ value: "", label: "— 無 —" }].concat(EQUIPMENT.accessory.map(w => ({ value: w.id, label: w.name }))) }))
            ),
            h("div", { className: "mt-3" }, h(CharCard, { ch: {
              id: partyState[0].id, name: ally.name, jobCode: ally.jobCode, lv: ally.lv, star: ally.star,
              baseStats: allyBase, eq: ally.eq, cur: { HP: allyBase.HP, MP: allyBase.MP }, isPlayer: true
            }, compact: false })),
            h("div", { className: "mt-2 text-xs text-slate-400" }, "成長曲線：使用 p50 形狀參數（預設 60%）。如要覆蓋，請展開下方 JSON 編輯。"),
            h(GrowthImport, { onApply: (data) => { Object.assign(CLASS_GROWTH, data); const base = scaleByJob(ally.jobCode, ally.lv) || allyBase; setPartyState([{ id: uid(), name: ally.name, jobCode: ally.jobCode, lv: ally.lv, star: ally.star, baseStats: base, eq: ally.eq, cur: { HP: base.HP, MP: base.MP }, isPlayer: true }]); } })
          )
        )
      );
    }

    function PrepPhase({ party, enemy, playerPattern, setPlayerPattern, openEquip, onStartBattle, onAbort }) { return h("div", { className: "p-4 max-w-5xl mx-auto space-y-3" },
      h(SectionCard, { title: "準備階段" }, h("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
        h("div", null, h("div", { className: "font-semibold mb-1" }, "我方隊伍"), h("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-3" }, party.map(ch => h(CharCard, { ch, key: ch.id, showEquip: true, compact: true })))),
        h("div", null, h("div", { className: "font-semibold mb-1" }, "下個敵人"), h("div", { className: "grid grid-cols-1 gap-3" }, enemy.map(e => h(CharCard, { ch: e, key: e.id, showEquip: false }))))),
      h("div", { className: "mt-3 grid grid-cols-1 md:grid-cols-3 gap-3" },
        h("div", { className: "md:col-span-2 bg-slate-900/60 border border-slate-700 rounded-xl p-3" }, h("div", { className: "text-sm font-semibold mb-2" }, "玩家三段攻擊流程（L/H/S）"),
          h("div", { className: "flex items-center gap-2" }, [0,1,2].map(i => h("select", { key: i, value: playerPattern[i], onChange: e => { const next = playerPattern.slice(); next[i] = e.target.value; setPlayerPattern(next); }, className: "bg-slate-800 border border-slate-600 rounded px-2 py-1" }, ["L","H","S"].map(k => h("option", { key: k, value: k }, k)))), h("div", { className: "text-xs text-slate-400" }, "命中加成：第1/2/3下 +0/+10/+20%"))),
        h("div", { className: "flex flex-col gap-2" }, h("button", { onClick: openEquip, className: "px-3 py-2 rounded-lg bg-sky-700 hover:bg-sky-600 text-sm" }, "裝備管理"), h("button", { onClick: onStartBattle, className: "px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-bold" }, "開始戰鬥"), h("button", { onClick: onAbort, className: "px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 hover:border-slate-500 text-sm" }, "返回主畫面")))); }

    function Battle({ party, enemies, roomIndex, missionLog, onBattleEnd }) { const [state, setState] = React.useState({ party, enemies, done: false, outcome: "ongoing", logs: missionLog }); const [auto, setAuto] = React.useState(true);
      React.useEffect(() => {
        if (state.done || !auto) return;
        const t = setTimeout(() => {
          const res = simulateRound(state.party, state.enemies, ["L","H","S"], ["L","L","L"], state.logs, roomIndex);
          const done = res.outcome !== "ongoing";
          setState({ party: res.party, enemies: res.enemies, logs: res.logs, done, outcome: res.outcome });
          if (done) setTimeout(() => onBattleEnd(res.outcome, res.party, res.logs), 500);
        }, 350);
        return () => clearTimeout(t);
      }, [state, auto]);

      const ally = state.party, foe = state.enemies;
      return h("div", { className: "p-4 max-w-6xl mx-auto space-y-3" },
        h(SectionCard, { title: "戰鬥中 · 房間 " + (roomIndex+1) },
          h("div", { className: "grid grid-cols-1 lg:grid-cols-3 gap-3" },
            h("div", { className: "lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3" },
              h("div", null, h("div", { className: "font-semibold mb-1" }, "我方"), h("div", { className: "grid grid-cols-1 gap-2" }, ally.map(ch => h(CharCard, { ch, key: ch.id, compact: true })))),
              h("div", null, h("div", { className: "font-semibold mb-1" }, "敵方"), h("div", { className: "grid grid-cols-1 gap-2" }, foe.map(ch => h(CharCard, { ch, key: ch.id, compact: true }))))
            ),
            h("div", null,
              h("div", { className: "font-semibold mb-1" }, "戰鬥紀錄（跨房間保留）"),
              h("div", { className: "h-64 overflow-auto scroll-soft text-sm bg-slate-950/50 border border-slate-800 rounded-lg p-2 space-y-1" }, state.logs.map((line, i) => h("div", { key: i, className: "text-slate-300" }, line))),
              h("div", { className: "mt-2 flex items-center justify-between" },
                h("label", { className: "inline-flex items-center gap-2 text-xs text-slate-400" }, h("input", { type: "checkbox", checked: auto, onChange: e => setAuto(e.target.checked) }), "自動進行"),
                h("div", { className: "text-xs text-slate-400" }, state.outcome === "ongoing" ? "戰鬥進行中…" : (state.outcome==="victory"?"勝利":"全滅"))
              )
            )
          )
        )
      );
    }

    function App() {
      const [view, setView] = useState("home");
      const [party, setParty] = useState([PLAYER]);
      const [pool] = useState(COMP_POOL);
      const [mission, setMission] = useState(null);
      const [roomIndex, setRoomIndex] = useState(0);
      const [enemies, setEnemies] = useState([]);
      const [missionLog, setMissionLog] = useState([]);
      const [playerPattern, setPlayerPattern] = useState(["L","H","S"]);

      function toastLocked() { alert("此功能暫未開放。"); }
      function openEquip() { setView("equip"); }
      function openBag() { alert("背包目前僅展示用途，尚未開放操作。"); }
      function openSettings() { alert("設定（placeholder）。"); }
      function goHome() { setView("home"); }

      useEffect(() => {
        if (view === "home") {
          setParty(prev => fullHeal(prev));
          setMission(null);
          setRoomIndex(0);
          setEnemies([]);
          setMissionLog([]);
        }
      }, [view]);

      function startMission(diff) {
        const roomEnemies = mkEnemySet(diff).map((e) => ({
          id: uid(), name: e.name, jobCode: "EN", lv: 1,
          star: { abbr: "--", symbol: "" }, starText: "",
          baseStats: e.base, eq: { weapon: null, body: null, accessory: null },
          cur: { HP: e.base.HP, MP: e.base.MP }, isPlayer: false, race: e.race
        }));
        setMission({ diff, rooms: roomEnemies.length });
        setRoomIndex(0); setEnemies([roomEnemies[0]]); setMissionLog([]); setView("prep");
      }

      function addCompanion(c) {
        if (party.length >= 4) return;
        const t = deepMerge({}, c); t.id = uid(); t.cur = { HP: effStats(t).HP, MP: effStats(t).MP };
        setParty(prev => [...prev, t]);
      }
      function removeCompanion(c) { setParty(prev => prev.filter(x => x.id !== c.id)); }
      function equipChar(charId, slot, item) {
        setParty(prev => prev.map(ch => {
          if (ch.id !== charId) return ch;
          const beforeEff = effStats(ch);
          const next = { ...ch, eq: { ...ch.eq, [slot]: item } };
          const afterEff = effStats(next);
          const hpRatio = ch.cur.HP / Math.max(1, beforeEff.HP);
          const mpRatio = ch.cur.MP / Math.max(1, beforeEff.MP);
          next.cur = { HP: clamp(Math.round(afterEff.HP * hpRatio), 0, afterEff.HP), MP: clamp(Math.round(afterEff.MP * mpRatio), 0, afterEff.MP) };
          return next;
        }));
      }
      function beginBattle() { setView("battle"); }
      function onBattleEnd(outcome, newParty, newLogs) {
        setMissionLog(newLogs); setParty(newParty);
        if (!mission) { setView("home"); return; }
        const totalRooms = mission.rooms;
        if (outcome === "defeat") { alert("隊伍全滅，返回主畫面。"); setView("home"); return; }
        if (roomIndex + 1 >= totalRooms) { alert("任務完成！即將返回主畫面。"); setView("home"); }
        else {
          const healed = healBetweenRooms(newParty); setParty(healed);
          const roomEnemies = mkEnemySet(mission.diff);
          setRoomIndex(roomIndex + 1);
          setEnemies([{ id: uid(), name: roomEnemies[roomIndex + 1].name, jobCode: "EN", lv: 1, star: { abbr: "--", symbol: "" }, starText: "", baseStats: roomEnemies[roomIndex + 1].base, eq: { weapon: null, body: null, accessory: null }, cur: { HP: roomEnemies[roomIndex + 1].base.HP, MP: roomEnemies[roomIndex + 1].base.MP }, isPlayer: false, race: roomEnemies[roomIndex + 1].race }]);
          setView("prep");
        }
      }

      const content =
        view === "home"  ? h(HomeScreen, { goBoard: () => setView("board"), goRelay: () => setView("relay"), goSim: () => setView("sim"), openLocked: toastLocked, party }) :
        view === "board" ? h(Board, { onStart: startMission, onBack: () => setView("home") }) :
        view === "relay" ? h(LinkRelay, { pool, party, onAdd: addCompanion, onRemove: removeCompanion, onBack: () => setView("home") }) :
        view === "equip" ? h(EquipManager, { party, onEquip: equipChar, onClose: () => setView("home") }) :
        view === "prep"  ? h(PrepPhase, { party, enemy: enemies, playerPattern, setPlayerPattern, openEquip: () => setView("equip"), onStartBattle: beginBattle, onAbort: () => setView("home") }) :
        view === "battle"? h(Battle, { party, enemies, roomIndex, missionLog, onBattleEnd }) :
        view === "sim"  ? h(SimLab, { onBack: () => setView("home") }) :
        h("div", null, "Unknown view");

      return h("div", { className: "min-h-screen flex flex-col" },
        h(Header, { onOpenEquip: () => setView("equip"), onOpenBag: openBag, onOpenSettings: openSettings, onHome: () => setView("home"), onOpenSim: () => setView("sim") }),
        h("main", { className: "flex-1" }, content),
        h("footer", { className: "py-4 text-center text-xs text-slate-500" }, "Build: React 18 (production UMD) · 無 Babel · 單檔 index.html")
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(h(App));
  })();
  </script>
</body>
</html>
